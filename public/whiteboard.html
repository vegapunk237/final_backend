<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tableau Blanc â€” KH Perfection</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { display: flex; flex-direction: column; height: 100vh; background: #f1f5f9; font-family: system-ui, sans-serif; overflow: hidden; }

    /* â”€â”€ Header â”€â”€ */
    #header {
      background: linear-gradient(135deg, #1a1a2e, #2b1055);
      padding: 10px 16px;
      display: flex; align-items: center; gap: 14px;
      border-bottom: 2px solid rgba(253,216,53,0.4);
      flex-shrink: 0;
    }
    #header .logo { font-size: 24px; background: rgba(253,216,53,0.15); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    #header h1 { font-size: 16px; font-weight: bold; color: #FDD835; margin: 0; }
    #header p  { font-size: 12px; color: #9ca3af; margin: 0; }
    #header .actions { margin-left: auto; display: flex; gap: 8px; }

    /* â”€â”€ Toolbar â”€â”€ */
    #toolbar {
      background: #1e293b;
      padding: 8px 14px;
      display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
      border-bottom: 1px solid rgba(253,216,53,0.2);
      flex-shrink: 0;
    }
    .tool-group { display: flex; align-items: center; gap: 5px; }
    .sep { width: 1px; height: 32px; background: rgba(255,255,255,0.15); flex-shrink: 0; }
    .tool-label { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; margin-right: 4px; }

    button.tool-btn {
      width: 36px; height: 36px; border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.06);
      font-size: 17px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
    }
    button.tool-btn.active { background: rgba(253,216,53,0.25); border-color: #FDD835; box-shadow: 0 0 8px rgba(253,216,53,0.3); }
    button.tool-btn:hover  { background: rgba(255,255,255,0.12); }

    .color-dot {
      width: 22px; height: 22px; border-radius: 50%; cursor: pointer;
      border: 2px solid rgba(0,0,0,0.15);
      flex-shrink: 0; transition: transform 0.1s;
    }
    .color-dot.active { border: 3px solid #FDD835; transform: scale(1.3); }

    input[type=color] { width: 26px; height: 26px; border: none; cursor: pointer; background: none; padding: 0; border-radius: 4px; }
    input[type=range] { width: 80px; accent-color: #FDD835; }

    button.action-btn {
      padding: 6px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid;
    }
    .btn-green  { background: rgba(34,197,94,0.2);  border-color: rgba(34,197,94,0.4);  color: #22c55e; }
    .btn-red    { background: rgba(239,68,68,0.2);  border-color: rgba(239,68,68,0.4);  color: #fca5a5; }
    .btn-yellow { background: rgba(253,216,53,0.2); border-color: rgba(253,216,53,0.4); color: #FDD835; }

    /* â”€â”€ Hint â”€â”€ */
    #hint {
      background: rgba(34,197,94,0.12);
      border-bottom: 1px solid rgba(34,197,94,0.2);
      padding: 7px 16px; font-size: 12px; color: #22c55e; flex-shrink: 0;
    }

    /* â”€â”€ Canvas â”€â”€ */
    #canvas-wrapper { flex: 1; position: relative; overflow: hidden; }
    canvas { display: block; width: 100%; height: 100%; touch-action: none; }

    /* â”€â”€ Footer â”€â”€ */
    #footer {
      background: #1e293b; padding: 8px 16px;
      display: flex; justify-content: space-between; align-items: center;
      border-top: 1px solid rgba(253,216,53,0.2); flex-shrink: 0;
      font-size: 12px; color: #64748b;
    }
    #status { display: flex; align-items: center; gap: 8px; }
    #color-preview { width: 14px; height: 14px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); }
  </style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div class="logo">ğŸ–Šï¸</div>
  <div>
    <h1>Tableau Blanc â€” KH Perfection</h1>
    <p id="course-name">Cours en cours</p>
  </div>
  <div class="actions">
    <button class="action-btn btn-yellow" onclick="undoCanvas()">â†©ï¸ Annuler</button>
    <button class="action-btn btn-red"    onclick="clearCanvas()">ğŸ—‘ï¸ Effacer</button>
    <button class="action-btn btn-green"  onclick="downloadCanvas()">â¬‡ï¸ TÃ©lÃ©charger</button>
  </div>
</div>

<!-- TOOLBAR -->
<div id="toolbar">
  <span class="tool-label">Outil</span>
  <div class="tool-group">
    <button class="tool-btn active" id="btn-pen"    onclick="setTool('pen')"    title="Stylo">âœï¸</button>
    <button class="tool-btn"        id="btn-eraser" onclick="setTool('eraser')" title="Gomme">ğŸ§¹</button>
    <button class="tool-btn"        id="btn-line"   onclick="setTool('line')"   title="Ligne">ğŸ“</button>
    <button class="tool-btn"        id="btn-rect"   onclick="setTool('rect')"   title="Rectangle">â¬œ</button>
    <button class="tool-btn"        id="btn-circle" onclick="setTool('circle')" title="Cercle">â­•</button>
    <button class="tool-btn"        id="btn-text"   onclick="setTool('text')"   title="Texte">ğŸ”¤</button>
  </div>

  <div class="sep"></div>
  <span class="tool-label">Couleur</span>
  <div class="tool-group" id="colors-row"></div>
  <input type="color" id="custom-color" title="Couleur personnalisÃ©e" onchange="setColor(this.value)" />

  <div class="sep"></div>
  <span class="tool-label">Ã‰paisseur</span>
  <div class="tool-group">
    <input type="range" id="size-slider" min="1" max="30" value="4" oninput="setSize(this.value)" />
    <span id="size-label" style="color:#FDD835;font-size:12px;font-weight:700;min-width:28px;">4px</span>
  </div>
</div>

<!-- HINT -->
<div id="hint">
  âœ… <strong>Partage d'Ã©cran :</strong> Dans la visio ZegoCloud, cliquez "Partager l'Ã©cran" puis sÃ©lectionnez <strong>cet onglet</strong> â€” l'Ã©lÃ¨ve verra uniquement le tableau, sans boucle d'image.
</div>

<!-- CANVAS -->
<div id="canvas-wrapper">
  <canvas id="wb-canvas"></canvas>
</div>

<!-- FOOTER -->
<div id="footer">
  <span>ğŸ’¡ Dessinez â€” l'Ã©lÃ¨ve voit ce tableau via le partage d'Ã©cran ZegoCloud</span>
  <div id="status">
    <div id="color-preview"></div>
    <span id="status-text">Stylo â€” 4px</span>
  </div>
</div>

<script>
  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const canvas  = document.getElementById('wb-canvas');
  const ctx     = canvas.getContext('2d');
  const wrapper = document.getElementById('canvas-wrapper');

  let tool      = 'pen';
  let color     = '#1a1a2e';
  let size      = 4;
  let isDrawing = false;
  let lastX = 0, lastY = 0;
  let snapshot  = null;
  let history   = [];

  const COLORS = ['#1a1a2e','#000000','#ef4444','#f97316','#f59e0b','#FDD835','#22c55e','#3b82f6','#8b5cf6','#ec4899','#ffffff'];

  // Lire le nom du cours depuis l'URL
  const params = new URLSearchParams(window.location.search);
  const courseName = params.get('course');
  if (courseName) document.getElementById('course-name').textContent = decodeURIComponent(courseName);

  // â”€â”€ Palette de couleurs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const colorsRow = document.getElementById('colors-row');
  COLORS.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'color-dot' + (c === color ? ' active' : '');
    btn.style.background = c;
    btn.title = c;
    btn.onclick = () => setColor(c);
    colorsRow.appendChild(btn);
  });

  // â”€â”€ Resize canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function resizeCanvas() {
    const rect = wrapper.getBoundingClientRect();
    const snap = ctx.getImageData(0, 0, canvas.width, canvas.height);
    canvas.width  = rect.width;
    canvas.height = rect.height;
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    try { ctx.putImageData(snap, 0, 0); } catch(e) {}
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const src  = e.touches ? e.touches[0] : e;
    return { x: src.clientX - rect.left, y: src.clientY - rect.top };
  }

  function setTool(t) {
    tool = t;
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + t)?.classList.add('active');
    canvas.style.cursor = t === 'eraser' ? 'cell' : t === 'text' ? 'text' : 'crosshair';
    updateStatus();
  }

  function setColor(c) {
    color = c;
    document.querySelectorAll('.color-dot').forEach(b => { b.classList.remove('active'); if (b.style.background === c || b.title === c) b.classList.add('active'); });
    document.getElementById('custom-color').value = c;
    updateStatus();
  }

  function setSize(s) {
    size = parseInt(s);
    document.getElementById('size-label').textContent = size + 'px';
    updateStatus();
  }

  function updateStatus() {
    document.getElementById('color-preview').style.background = color;
    const toolNames = { pen: 'Stylo', eraser: 'Gomme', line: 'Ligne', rect: 'Rectangle', circle: 'Cercle', text: 'Texte' };
    document.getElementById('status-text').textContent = `${toolNames[tool]} â€” ${size}px`;
  }
  updateStatus();

  function saveHistory() {
    history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
    if (history.length > 20) history.shift();
  }

  function undoCanvas() {
    if (history.length === 0) return;
    ctx.putImageData(history.pop(), 0, 0);
  }

  function clearCanvas() {
    if (!confirm('Effacer tout le tableau ?')) return;
    saveHistory();
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  function downloadCanvas() {
    const link    = document.createElement('a');
    link.download = 'tableau-cours.png';
    link.href     = canvas.toDataURL('image/png');
    link.click();
  }

  // â”€â”€ Dessin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startDraw(e) {
    e.preventDefault();
    if (tool === 'text') {
      const pos  = getPos(e);
      const text = prompt('Entrez votre texte :');
      if (text) {
        saveHistory();
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = color;
        ctx.font = `bold ${size * 4}px sans-serif`;
        ctx.fillText(text, pos.x, pos.y);
      }
      return;
    }
    isDrawing  = true;
    const pos  = getPos(e);
    lastX = pos.x; lastY = pos.y;
    snapshot   = ctx.getImageData(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
  }

  function draw(e) {
    e.preventDefault();
    if (!isDrawing) return;
    const pos = getPos(e);
    ctx.lineCap  = 'round';
    ctx.lineJoin = 'round';

    if (tool === 'pen') {
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = color;
      ctx.lineWidth   = size;
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      lastX = pos.x; lastY = pos.y;
    } else if (tool === 'eraser') {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.lineWidth = size * 6;
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      lastX = pos.x; lastY = pos.y;
    } else {
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = color;
      ctx.lineWidth   = size;
      ctx.putImageData(snapshot, 0, 0);
      ctx.beginPath();
      if (tool === 'line')   { ctx.moveTo(lastX, lastY); ctx.lineTo(pos.x, pos.y); ctx.stroke(); }
      if (tool === 'rect')   { ctx.strokeRect(lastX, lastY, pos.x - lastX, pos.y - lastY); }
      if (tool === 'circle') { const r = Math.sqrt((pos.x-lastX)**2 + (pos.y-lastY)**2); ctx.arc(lastX, lastY, r, 0, Math.PI*2); ctx.stroke(); }
    }
  }

  function stopDraw() {
    if (!isDrawing) return;
    isDrawing = false;
    ctx.globalCompositeOperation = 'source-over';
    saveHistory();
  }

  canvas.addEventListener('mousedown',  startDraw);
  canvas.addEventListener('mousemove',  draw);
  canvas.addEventListener('mouseup',    stopDraw);
  canvas.addEventListener('mouseleave', stopDraw);
  canvas.addEventListener('touchstart', startDraw, { passive: false });
  canvas.addEventListener('touchmove',  draw,      { passive: false });
  canvas.addEventListener('touchend',   stopDraw);
</script>
</body>
</html>
